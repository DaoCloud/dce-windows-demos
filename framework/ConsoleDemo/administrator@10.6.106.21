FROM microsoft/dotnet-framework:4.7.1-sdk-windowsservercore-1709 AS build
WORKDIR /app

# copy csproj and restore as distinct layers
COPY *.sln .
COPY ConsoleDemo/ConsoleDemo.csproj ./dotnetapp/

WORKDIR /app/dotnetapp

RUN dotnet restore

# copy everything else and build app
COPY . .

RUN dotnet build

FROM build AS publish
WORKDIR /app/dotnetapp
RUN dotnet publish -c Release -o out



# run time
FROM microsoft/aspnet:4.7.1-windowsservercore-1709 AS runtime
WORKDIR /app

RUN net user /add custom-admin
RUN net localgroup Administrators custom-admin /add
USER custom-admin

COPY --from=publish /app/dotnetapp/out ./

ENTRYPOINT ["ConsoleDemo.exe"]
